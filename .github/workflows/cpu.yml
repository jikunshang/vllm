name: cpu_ci

on: 
  pull_request:
    branches:
      - cpu_pr

jobs:
  build:
    runs-on: self-hosted-cpu
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      # This is the version of the action for setting up Python, not the Python version.
      uses: actions/setup-python@v4
      with:
        # Semantic version range syntax or exact version of a Python version
        python-version: '3.10'
        # Optional - x64 or x86 architecture, defaults to x64
        architecture: 'x64'
        cache: 'pip' 
    - name: setup env
      run: |
        pip config --user set global.extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements-build.txt --root-user-action=ignore
        pip install -r requirements-dev.txt --root-user-action=ignore
        pip install -r requirements-cpu.txt --root-user-action=ignore
    - name: build
      run: |
        VLLM_TARGET_DEVICE=cpu pip install --no-build-isolation -v -e . --root-user-action=ignore

    - name: offline_inference test
      run: |
        python examples/offline_inference.py 
